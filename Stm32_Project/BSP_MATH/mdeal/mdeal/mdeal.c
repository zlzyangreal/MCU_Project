#include "mdeal.h"

uint16_t DEAL_Buffer[NUM_SIZE]={0};
uint16_t OUTPUT_Buffer[NUM_SIZE]={0};
extern uint16_t ADC_Buffer[];

uint16_t fft_size = NUM_SIZE/4;
float fft_inputbuf[NUM_SIZE*2];	//FFT输入数组
float fft_outputbuf[NUM_SIZE];	//FFT输出数组
uint16_t FFT_OUTPUT_Buffer[NUM_SIZE]={0};

//-----------------------------------------------------------------------------------------------------------------------------------------------//
//
//图像平滑处理
//
//-----------------------------------------------------------------------------------------------------------------------------------------------//

//5点平滑处理，7点精度更高
void smooth5(uint16_t *x,int m)
{
	uint16_t  a[NUM_SIZE]={0};
	int get_i,deal_i,deal_j,deal_k,end_i;
	for(get_i=0;get_i<NUM_SIZE;get_i++)
	{
	  a[get_i] = x[get_i];
	}
	for(deal_i=0;deal_i<m;deal_i++)
	{
	  uint16_t  b[NUM_SIZE]={0};
// 计算第一个元素的平滑值
    b[0] = (69 * a[0] + 4 * (a[1] + a[3]) - 6 * a[2] - a[4]) / 70;
// 计算第二个元素的平滑值
    b[1] = (2 * (a[0] + a[4]) + 27 * a[1] + 12 * a[2] - 8 * a[3]) / 35;
// 对中间的元素进行平滑计算
//    for (deal_j = 2; deal_j < NUM_SIZE - 2; deal_j++)
//		{
//        b[deal_j] = (-3 * (a[deal_j-2] + a[deal_j+2]) + 12 * (a[deal_j-1] + a[deal_j+1]) + 17 * a[deal_j]) / 35;
//    }
//考虑0	,但出现断崖	
		 for (deal_j = 2; deal_j < NUM_SIZE - 2; deal_j++) {
            if (a[deal_j-2] != 0 && a[deal_j-1] != 0 && a[deal_j] != 0 && a[deal_j+1] != 0 && a[deal_j+2] != 0) {
                b[deal_j] = (-3 * (a[deal_j-2] + a[deal_j+2]) + 12 * (a[deal_j-1] + a[deal_j+1]) + 17 * a[deal_j]) / 35;
            } else {
                b[deal_j] = a[deal_j];
            }
        }

// 计算倒数第二个元素的平滑值
    b[NUM_SIZE - 2] = (2 * (a[NUM_SIZE-1] + a[NUM_SIZE-5]) + 27 * a[NUM_SIZE-2] + 12 * a[NUM_SIZE-3] - 8 * a[NUM_SIZE-4]) / 35;
// 计算最后一个元素的平滑值
    b[NUM_SIZE - 1] = (69 * a[NUM_SIZE-1] + 4 * (a[NUM_SIZE-2] + a[NUM_SIZE-4]) - 6 * a[NUM_SIZE-3] - a[NUM_SIZE-5]) / 70;
// 将计算得到的平滑值赋值给变量a
    for (deal_k = 0; deal_k < NUM_SIZE; deal_k++) 
		{
        a[deal_k] = b[deal_k];
    }
	}
	for(end_i=0;end_i<NUM_SIZE;end_i++)
	{
	  DEAL_Buffer[end_i] = a[end_i];
	}
}
//二次函数拟合,采用7点拟合
void qua_smooth(uint16_t *x,int m)
{
  int i,end_i;
	uint16_t  z[NUM_SIZE]={0};
	if(m<7)
	{
	  for(i=0;i<=m-1;i++)
		{
		  OUTPUT_Buffer[i]=x[i];
		}
	}else
	{
	  z[0] = ( 32.0 * x[0] + 15.0 * x[1] + 3.0 * x[2] - 4.0 * x[3] - 6.0 * x[4] - 3.0 * x[5] + 5.0 * x[6] ) / 42.0;
    z[1] = ( 5.0 * x[0] + 4.0 * x[1] + 3.0 * x[2] + 2.0 * x[3] + x[4] - x[6] ) / 14.0;
    z[2] = ( 1.0 * x[0] + 3.0 * x [1] + 4.0 * x[2] + 4.0 * x[3] + 3.0 * x[4] + 1.0 * x[5] - 2.0 * x[6] ) / 14.0;
    for ( i = 3; i <= NUM_SIZE - 4; i++ )
        {
            z[i] = ( -2.0 * (x[i - 3] + x[i + 3]) + 3.0 * (x[i - 2] + x[i + 2]) +  6.0 * (x[i - 1] + x[i + 1]) + 7.0 * x[i] ) / 21.0;
        }
    z[NUM_SIZE - 3] = ( 1.0 * x[NUM_SIZE - 1] + 3.0 * x [NUM_SIZE - 2] + 4.0 * x[NUM_SIZE - 3] + 4.0 * x[NUM_SIZE - 4] + 3.0 * x[NUM_SIZE - 5] + 1.0 * x[NUM_SIZE - 6] - 2.0 * x[NUM_SIZE - 7] ) / 14.0;
    z[NUM_SIZE - 2] = ( 5.0 * x[NUM_SIZE - 1] + 4.0 * x[NUM_SIZE - 2] + 3.0 * x[NUM_SIZE - 3] + 2.0 * x[NUM_SIZE - 4] + x[NUM_SIZE - 5] - x[NUM_SIZE - 7] ) / 14.0;
    z[NUM_SIZE - 1] = ( 32.0 * x[NUM_SIZE - 1] + 15.0 * x[NUM_SIZE - 2] + 3.0 * x[NUM_SIZE - 3] - 4.0 * x[NUM_SIZE - 4] - 6.0 * x[NUM_SIZE - 5] - 3.0 * x[NUM_SIZE - 6] + 5.0 * x[NUM_SIZE - 7] ) / 42.0;
    }
		for(end_i=0;end_i<NUM_SIZE;end_i++)
	{
	  OUTPUT_Buffer[end_i] = z[end_i];
	}
}
void NUM_DEAL(void)
{
   smooth5(ADC_Buffer,50);
	 qua_smooth(DEAL_Buffer,50);
}
//-----------------------------------------------------------------------------------------------------------------------------------------------//
//
//FFT处理
//
//-----------------------------------------------------------------------------------------------------------------------------------------------//

void FFT_DEAL(void)
{
		uint16_t i;
	delay_ms(1);
//	arm_cfft_radix4_instance_f32 scfft;

//	arm_cfft_radix4_init_f32(&scfft,fft_size,0,1);//初始化scfft结构体，设定FFT相关参数
  for(i=0;i<fft_size;i++)
	{
           fft_inputbuf[2*i] = (float32_t)((ADC_Buffer[i] * 3.3)/4096);
//		       fft_inputbuf[2*i]=100+
//				                   10*arm_sin_f32(2*PI*i/fft_size)+
//								   30*arm_sin_f32(2*PI*i*4/fft_size)+
//				                   50*arm_cos_f32(2*PI*i*8/fft_size);	//生成输入信号实部
           fft_inputbuf[2*i + 1] = 0;
  }  
//-----------------------------------------------------------------------//
//
//void arm_cfft_f32{
// const arm_cfft_instance_f32 * S,//指向arm_cfft_instance_f32类型结构体的指针，内部存储了FFT的状态和配置信息
//	                               //只要是2的倍数例如arm_cfft_sR_f32_len64、arm_cfft_sR_f32_len8192
// float32_t * p1,                 //指向输入/输出数据的指针
// uint8_t ifftFlag,               //用于选择是进行正向（FFT）还是逆向（逆FFT）变换。如果设置为1，进行逆向变换；如果设置为0，进行正向变换
// uint8_t bitReverseFlag          //是否进行位反转操作。如果设置为1，进行位反转；如果设置为0，不进行位反转
//}
//	
//-----------------------------------------------------------------------//	
    arm_cfft_f32(&arm_cfft_sR_f32_len1024, fft_inputbuf, 0, 1); 
//     arm_cfft_radix4_f32(&scfft,fft_inputbuf);	//FFT计算（基4）
//-----------------------------------------------------------------------//
//
//该函数用于计算复数序列的模值，即将每个复数的实部和虚部视为坐标平面上的点，计算它们到原点的距离
//|Z| = sqrt(Re^2 + Im^2)	
//	
//-----------------------------------------------------------------------//
    arm_cmplx_mag_f32(fft_inputbuf, fft_outputbuf, fft_size);
  }

	
	
//-----------------------------------------------------------------------------------------------------------------------------------------------//
//
//IIR滤波处理(f4性能不支持使用)
//
//-----------------------------------------------------------------------------------------------------------------------------------------------//
/* IIR滤波的阶数 */
//#define numStages  4 

///* 巴特沃斯低通滤波器系数*/
//const float a[numStages+1] = { 1.0f,-3.835825540647348042000430723419412970543f, 5.52081913662222678595981051330454647541f,-3.533535219463013632434922328684478998184f,
//0.84855599926647662378798031568294391036f};
//const float b[numStages+1] = {0.000000898486146397064471459551013993172f,0.000003593944585588257885838204055972689f,0.000005390916878382387040515542897534118f,0.000003593944585588257885838204055972689f,
//0.000000898486146397064471459551013993172f};

//static float old_x[numStages] = {0.0f};
//static float old_y[numStages] = {0.0f};
//static int pos = 0;

//float arm_iir_f32_bp(float input)
//{
//    int i,p;
//    float output = b[0] * input;
//    for(i=1; i<=numStages; i++)
//    {
//        p=(pos + numStages - i)%numStages;
//        output += b[i] * old_x[p] - a[i] * old_y[p];
//    }
//    if(numStages > 1) {
//        old_x[pos] = input;
//        old_y[pos] = output;
//        pos = (pos+1)%numStages;
//    }
//		
//    return output;
//}
//-----------------------------------------------------------------------------------------------------------------------------------------------//
//
//FIR滤波处理
//
//-----------------------------------------------------------------------------------------------------------------------------------------------//

#define NUM_TAPS 501//滤波器阶数（处理点数）
#define BLOCK_SIZE 1//调用一次函数，处理采样点个数

static float32_t fir_state[BLOCK_SIZE+NUM_TAPS-1];
uint32_t BlockSize = BLOCK_SIZE;
arm_fir_instance_f32 S;

const float fir_matalab_fadtool[NUM_TAPS] = {
-8.095077333e-18,6.715620657e-06,7.970656043e-06, 3.04475634e-06,-8.115351193e-06,
  -2.48693832e-05,-4.591665856e-05,-6.938767183e-05,-9.298833902e-05,-0.0001141867833,
  -0.0001304290636,-0.0001393672137,-0.000139081385,-0.0001282778685,-0.0001064452226,
  -7.395379362e-05,-3.208752969e-05,1.699821223e-05, 7.03934129e-05,0.0001246190659,
  0.0001758703729,0.0002203006297,0.0002543243754,0.0002749161795,0.0002798794303,
  0.0002680619946,0.0002394970215,0.0001954540785,0.0001383911149, 7.18066949e-05,
  2.478588389e-18,-7.224531146e-05,-0.0001400300243, -0.00019873165,-0.0002443872218,
  -0.0002740328782,-0.0002859683591,-0.0002799203794,-0.0002570854558,-0.0002200436284,
  -0.0001725455077,-0.0001191864721,-6.499324809e-05,-1.495726974e-05,2.644417691e-05,
  5.569456334e-05,7.060904318e-05,7.059083146e-05,5.674304703e-05,3.181795546e-05,
  7.880780272e-19,-3.346542144e-05,-6.277029024e-05,-8.21285139e-05,-8.639531006e-05,
  -7.166384603e-05,-3.578007818e-05,2.127878724e-05,9.720720846e-05,0.0001873863075,
  0.0002851234167,0.0003821081773, 0.000469056773,0.0005364964018,0.0005756258615,
   0.000579177984,0.0005422044196,0.0004627066082,0.0003420450957,0.0001850781264,
  -1.846788458e-18,-0.0002021227119,-0.0004080927174,-0.0006035499973,-0.0007740922738,
  -0.0009064558544,-0.0009896556148,-0.001015981776,-0.0009817590471,-0.0008877901128,
  -0.0007394329878,-0.0005462904228,-0.0003215237521,-8.083931607e-05,0.0001587735169,
  0.0003804490552,0.0005688745296,0.0007116142078,0.0008002054528,0.0008309197729,
  0.0008051095647,0.0007290965877,0.0006135980366,0.0004727305204,0.0003226707922,
  0.0001800895116,6.049719741e-05,-2.334270539e-05,-6.278072397e-05,-5.428911027e-05,
  -1.898557681e-17,9.229678108e-05,0.0002097189863,0.0003353908251, 0.000449994317,
  0.0005336459726,0.0005679347087,0.0005379352369,0.0004340033629,0.0002531728242,
  -3.179441069e-17,-0.0003132517741,-0.0006671411102,-0.001036279951,-0.001391192083,
  -0.001700661029,-0.001934380503,-0.002065682085,-0.002074099379,-0.001947530429,
  -0.001683786279,-0.001291360939,-0.0007893170114,-0.0002062606945,0.0004215441877,
   0.001052792068,  0.00164428202, 0.002154339338, 0.002546226373, 0.002791241044,
   0.002871228382, 0.002780263545, 0.002525339136, 0.002125964034, 0.001612685272,
   0.001024632133,0.0004062752414,-0.0001963288814,-0.0007394860731,-0.001185656642,
  -0.001506746165,-0.001686585369,-0.001722355722,-0.001624804805,-0.001417202409,
  -0.001133102342,-0.0008130870992,-0.0005007702275,-0.0002384102991,-6.253660104e-05,
  4.143008958e-18,-6.483666948e-05,-0.0002562713926,-0.0005580933066,-0.0009395182715,
  -0.001357519533,-0.001760470914,-0.002092818962, -0.00230039563,-0.002335905563,
  -0.002164086793,-0.001766053494,-0.001142379013,-0.0003145771625,0.0006752365152,
   0.001766559784, 0.002884492977, 0.003945231438, 0.004862647504, 0.005555432756,
   0.005954199936,  0.00600792421, 0.005689130165, 0.004997328389, 0.003960325848,
   0.002633218886,  0.00109506282,-0.0005565816537,-0.002212831285,-0.003761838423,
  -0.005097644869,-0.006128791254,-0.006785931531,-0.007027770858,-0.006844769698,
  -0.006260224618,-0.005328572355,-0.004130978137,-0.002768536098, -0.00135360437,
  -1.025280575e-16, 0.001187113463, 0.002120748162,  0.00274015544, 0.003016661154,
   0.002956674667, 0.002601504792, 0.002023891779, 0.001321447897,0.0006074903067,
  3.957077781e-18,-0.0003903626639,-0.0004721275764,-0.0001836778392, 0.000498330046,
   0.001553672832,  0.00291704433, 0.004480666015, 0.006101027597, 0.007609402761,
   0.008825435303, 0.009572791867, 0.009695646353, 0.009074623697, 0.007640808355,
   0.005386497825, 0.002371610608,-0.001275066985,-0.005360208917,-0.009635836817,
   -0.01381429564, -0.01758742332, -0.02064860612, -0.02271618508, -0.02355639264,
   -0.02300409228,  -0.0209795367, -0.01749972627, -0.01268319972,-0.006747618318,
  -3.93346285e-17, 0.007180006243,  0.01436283253,  0.02109626867,  0.02693548426,
    0.03147370368,  0.03437134624,  0.03538146615,  0.03436960652,  0.03132643178,
    0.02637210116,  0.01975186169,  0.01182297524, 0.003033722751,-0.006104178727,
   -0.01504793297, -0.02325860225, -0.03023624048,   -0.035552755, -0.03888024762,
     0.9603074789, -0.03888024762,   -0.035552755, -0.03023624048, -0.02325860225,
   -0.01504793297,-0.006104178727, 0.003033722751,  0.01182297524,  0.01975186169,
    0.02637210116,  0.03132643178,  0.03436960652,  0.03538146615,  0.03437134624,
    0.03147370368,  0.02693548426,  0.02109626867,  0.01436283253, 0.007180006243,
  -3.93346285e-17,-0.006747618318, -0.01268319972, -0.01749972627,  -0.0209795367,
   -0.02300409228, -0.02355639264, -0.02271618508, -0.02064860612, -0.01758742332,
   -0.01381429564,-0.009635836817,-0.005360208917,-0.001275066985, 0.002371610608,
   0.005386497825, 0.007640808355, 0.009074623697, 0.009695646353, 0.009572791867,
   0.008825435303, 0.007609402761, 0.006101027597, 0.004480666015,  0.00291704433,
   0.001553672832, 0.000498330046,-0.0001836778392,-0.0004721275764,-0.0003903626639,
  3.957077781e-18,0.0006074903067, 0.001321447897, 0.002023891779, 0.002601504792,
   0.002956674667, 0.003016661154,  0.00274015544, 0.002120748162, 0.001187113463,
  -1.025280575e-16, -0.00135360437,-0.002768536098,-0.004130978137,-0.005328572355,
  -0.006260224618,-0.006844769698,-0.007027770858,-0.006785931531,-0.006128791254,
  -0.005097644869,-0.003761838423,-0.002212831285,-0.0005565816537,  0.00109506282,
   0.002633218886, 0.003960325848, 0.004997328389, 0.005689130165,  0.00600792421,
   0.005954199936, 0.005555432756, 0.004862647504, 0.003945231438, 0.002884492977,
   0.001766559784,0.0006752365152,-0.0003145771625,-0.001142379013,-0.001766053494,
  -0.002164086793,-0.002335905563, -0.00230039563,-0.002092818962,-0.001760470914,
  -0.001357519533,-0.0009395182715,-0.0005580933066,-0.0002562713926,-6.483666948e-05,
  4.143008958e-18,-6.253660104e-05,-0.0002384102991,-0.0005007702275,-0.0008130870992,
  -0.001133102342,-0.001417202409,-0.001624804805,-0.001722355722,-0.001686585369,
  -0.001506746165,-0.001185656642,-0.0007394860731,-0.0001963288814,0.0004062752414,
   0.001024632133, 0.001612685272, 0.002125964034, 0.002525339136, 0.002780263545,
   0.002871228382, 0.002791241044, 0.002546226373, 0.002154339338,  0.00164428202,
   0.001052792068,0.0004215441877,-0.0002062606945,-0.0007893170114,-0.001291360939,
  -0.001683786279,-0.001947530429,-0.002074099379,-0.002065682085,-0.001934380503,
  -0.001700661029,-0.001391192083,-0.001036279951,-0.0006671411102,-0.0003132517741,
  -3.179441069e-17,0.0002531728242,0.0004340033629,0.0005379352369,0.0005679347087,
  0.0005336459726, 0.000449994317,0.0003353908251,0.0002097189863,9.229678108e-05,
  -1.898557681e-17,-5.428911027e-05,-6.278072397e-05,-2.334270539e-05,6.049719741e-05,
  0.0001800895116,0.0003226707922,0.0004727305204,0.0006135980366,0.0007290965877,
  0.0008051095647,0.0008309197729,0.0008002054528,0.0007116142078,0.0005688745296,
  0.0003804490552,0.0001587735169,-8.083931607e-05,-0.0003215237521,-0.0005462904228,
  -0.0007394329878,-0.0008877901128,-0.0009817590471,-0.001015981776,-0.0009896556148,
  -0.0009064558544,-0.0007740922738,-0.0006035499973,-0.0004080927174,-0.0002021227119,
  -1.846788458e-18,0.0001850781264,0.0003420450957,0.0004627066082,0.0005422044196,
   0.000579177984,0.0005756258615,0.0005364964018, 0.000469056773,0.0003821081773,
  0.0002851234167,0.0001873863075,9.720720846e-05,2.127878724e-05,-3.578007818e-05,
  -7.166384603e-05,-8.639531006e-05,-8.21285139e-05,-6.277029024e-05,-3.346542144e-05,
  7.880780272e-19,3.181795546e-05,5.674304703e-05,7.059083146e-05,7.060904318e-05,
  5.569456334e-05,2.644417691e-05,-1.495726974e-05,-6.499324809e-05,-0.0001191864721,
  -0.0001725455077,-0.0002200436284,-0.0002570854558,-0.0002799203794,-0.0002859683591,
  -0.0002740328782,-0.0002443872218, -0.00019873165,-0.0001400300243,-7.224531146e-05,
  2.478588389e-18, 7.18066949e-05,0.0001383911149,0.0001954540785,0.0002394970215,
  0.0002680619946,0.0002798794303,0.0002749161795,0.0002543243754,0.0002203006297,
  0.0001758703729,0.0001246190659, 7.03934129e-05,1.699821223e-05,-3.208752969e-05,
  -7.395379362e-05,-0.0001064452226,-0.0001282778685,-0.000139081385,-0.0001393672137,
  -0.0001304290636,-0.0001141867833,-9.298833902e-05,-6.938767183e-05,-4.591665856e-05,
  -2.48693832e-05,-8.115351193e-06, 3.04475634e-06,7.970656043e-06,6.715620657e-06,
  -8.095077333e-18
	
};

void fir_init(void)
{
  arm_fir_init_f32(&S,NUM_TAPS,(float32_t*)&fir_matalab_fadtool[0],&fir_state[0],1);
}

float fir_deal(float input)
{
  float output;
	arm_fir_f32(&S,&input,&output,1);
	return output;
}